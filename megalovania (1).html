<!DOCTYPE html>
<html lang="">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title></title>
    <style>
        body {
            text-align: center;
        }

        canvas {
            border: 1px solid white;
            cursor: pointer;
            background: black;
        }

        h2 {
            color: #0b5d69;
            font: bold italic 18px Calibri;
        }

    </style>
</head>

<body>
    <!-- Créer la balise canvas et modifier ensuite ses dimensions -->
    <canvas width="1200" height="900"></canvas>

    <script>
        /**
        *reproduction du combat final du parcour génocide dans undertale@license
        *@author Julien Poirier Morin
        *@version 2020/12/20
        */
        //Récupérer la balise canvas et définir son contexte de dessin en 2d
        let leCanvas = document.querySelector("canvas");
        let ctx = leCanvas.getContext("2d");
        //définir les musiques
        let determination = new Audio();
        determination.src = "son/determination.mp3";
        let megalovania = new Audio();
        megalovania.src = "son/megalovania.mp3";
        let musiqueMenu = new Audio();
        musiqueMenu.src = "son/OST-001.mp3";
        let musiqueFin = new Audio();
        musiqueFin.src = "son/OST-089.mp3";
        let skullAttaque = new Audio();
        skullAttaque.src = "son/skullAttack.mp3";
        //Variable pour générer le son
        let musiqueMenuJoue = false;
        let determinationJoue = false;
        let megalovaniaJoue = false;
        let musiqueFinJoue = false;
        let skullAttaqueJoue = false;
        //Dessiner l'image de départ
        let imgIntro = new Image();
        imgIntro.src = "images/imgIntro.png";
        ctx.drawImage(imgIntro, 0, 0);

        let sans = {
            img: new Image(),
            img2: new Image(),
            largeur: 200,
            hauteur: 268,
            posX: leCanvas.width / 2 - 100,
            vitesseX: 5,
            posXMax: leCanvas.width / 2 - 300,
            posXMin: leCanvas.width / 2 - 100
        }
        sans.img.src = "images/Sans_undertale.jpg";
        sans.img2.src = "images/sans_coupé.png";
        let sansVie = {
            img: new Image(),
            posX: 0,
            posY: 0,
            largeur: 30,
            hauteur: 28
        }
        sansVie.img.src = "images/sansVie.png";

        let nombreViesSans = 3;
        
        let bulle={
            img: new Image(),
            img2: new Image(),
            img3: new Image(),
            img4: new Image(),
            hauteur: 100,
            largeur: 233,
            posX: leCanvas.width/2 - 100,
            posY: 50
        }
        bulle.img.src="images/bulle1.png";
        bulle.img2.src="images/bulle2.png";
        bulle.img3.src="images/bulle3.png";
        bulle.img4.src="images/bulle4.png";
        let animDebut = false;
        let animMilieu = false;
        let animFin = false;
        let zoneJeu = {
            img: new Image(),
            posX: leCanvas.width / 2 - 250,
            posY: leCanvas.height / 2,
            largeur: 500,
            hauteur: 300
        }
        zoneJeu.img.src = "images/zoneDeJeu.png";

        //l'image du premier objet, qu'on pourra déplacer avec les touches
        let coeur = {
            img: new Image(),
            img2: new Image(),
            posX: leCanvas.width / 2 - 50,
            posY: leCanvas.height / 2 + 100,
            largeur: 100,
            hauteur: 100,
            vitesse: 100,
            posXMax: zoneJeu.posX + 400,
            posYMax: leCanvas.height / 2 + 200,
            posXMin: leCanvas.width / 2 - 250,
            posYMin: leCanvas.height / 2,
            pv: 15
        }
        coeur.img.src = "images/coeur.png";
        coeur.img2.src = "images/coeurBrisé.png";
        
        let vie = {
            img: new Image(),
            posX: leCanvas.width - 100,
            posY: 0,
            largeur: 100,
            hauteur: 100
        }
        vie.img.src = "images/coeur.png";

        let nombreVies = 5;

        let skull = {
            img: new Image(),
            largeur: 100,
            hauteur: 145,
            nbVignettes: 20,
            indexVignette: 0,
            sourceX: 0,
            posX: leCanvas.width / 2 - 250,
            posY: leCanvas.height / 2 - 145
        }
        skull.img.src = "images/skull.png";

        let skullH = {
            img: new Image(),
            largeur: 145,
            hauteur: 100,
            nbVignettes: 20,
            indexVignette: 0,
            sourceX: 0,
            posX: leCanvas.width/2+250,
            posY: leCanvas.height/2+100
        }
        skullH.img.src = "images/skullH.png";
        
        let attaque ={
            img: new Image(),
            largeur:0,
            hauteur:0,
            posY:-1
        }
        attaque.img.src ="images/rayon.png";
        
        let attaqueH ={
            img: new Image(),
            largeur:0,
            hauteur:0,
            posY:-1
        }
        attaqueH.img.src ="images/rayonH.png";
        //appeler la fonction pour dessiner l'intro
        imgIntro.addEventListener("load", initialiserJeu);

        //appeler la fonction pour démarer la musique
        //musique();

        //Variable pour gérer l'affichage du jeu
        let debutJeu = false;
        let enTir = false;
        let enTirH = false;
        let skip = false;
        let temps = 0;
        let timer = 0;
        let intervalIDAfficherNombreVie;//Sera défini quand l'utilisateur partira le jeu
        let intervalIDAfficherViesSans;//Sera défini quand l'utilisateur partira le jeu
        let intervalIDAnimationDebut; //Sera défini quand l'utilisateur partira le jeu
        let intervalIDActualiserJeu; //Sera défini quand l'utilisateur partira le jeu
        let intervalIDMinuterie; //Sera défini quand l'utilisateur partira le jeu
        let intervalIDScore; //Sera défini quand l'utilisateur partira le jeu
        let intervalIDAnimerSkull; //Sera défini quand l'utilisateur partira le jeu
        let intervalIDAnimerSkullH; //Sera défini quand l'utilisateur partira le jeu
        let tir;  //Sera défini quand l'utilisateur partira le jeu
        let tirH;  //Sera défini quand l'utilisateur partira le jeu
        let intervalIDTirer; //Sera défini à la vignette 10...
        let intervalIDTirerH; //Sera défini à la vignette 10...
        let difficultéChoisie; //Sera défini quand l'utilisateur partira le jeu
        let intervalIDTimer; //Sera défini quand l'utilisateur partira le jeu
        let difficulté1 = 12;
        let difficulté2 = 24;
        let difficulté3 = 36;
        //Pour savoir si les touches fléchées du clavier sont appuyées
        let flecheGauche = false;
        let flecheDroite = false;
        let flecheHaut = false;
        let flecheBas = false;

        //Pour savoir si les touches ont été appuyées
        let droite = true;
        let gauche = false;
        let haut = false;
        let bas = false;

        //Écouteur sur le document pour détecter si des touches de clavier sont appuyées 
        document.addEventListener("keydown", presserTouche);
        document.addEventListener("keyup", relacherTouche);
        leCanvas.addEventListener("click", musique);


        //********** SECTIONS DES FONCTIONS **********//


        function initialiserJeu() {
            ctx.drawImage(imgIntro, 0, 0);
        }
        function musique() {
            if (musiqueMenuJoue == false) {
                musiqueMenu.loop = true;
                musiqueMenu.play();
            } else {
                musiqueMenu.pause();
            }
            musiqueMenuJoue = !musiqueMenuJoue;

        }
        function musique3() {
            if (determinationJoue == false) {
                determination.loop = true;
                determination.play();
            } else {
                determination.pause();
            }
            determinationJoue = !determinationJoue;

        }
        function musique2() {
            if (musiqueMenuJoue == true) {
                musiqueMenu.pause();
                musiqueMenuJoue = false;
            }
            if (megalovaniaJoue == false) {
                megalovania.loop = true;
                megalovania.play();
            } else {
                megalovania.pause();
            }
            megalovaniaJoue = !megalovaniaJoue;

        }
        function musique4() {
            if (musiqueFinJoue == false) {
                musiqueFin.loop = true;
                musiqueFin.play();
            } else {
                musiqueFin.pause();
            }
            musiqueFinJoue = !musiqueFinJoue;

        }


        // Détecte quelles touches sont appuyées


        function presserTouche(event) {
            //Enregistrer si une touche gauche/droite est pressée
            if (event.keyCode == 39 || event.keyCode == 68) { //flèche droite
                flecheDroite = true;
                droite = false;
                if (droite == false) {
                    droite = true;
                }
            }
            if (event.keyCode == 37 || event.keyCode == 65) { //flèche gauche
                flecheGauche = true;
            }

            //Enregistrer si une touche haut/bas est pressée
            if (event.keyCode == 38 || event.keyCode == 87) { //flèche haut
                flecheHaut = true;
            }
            if (event.keyCode == 40 || event.keyCode == 83) { //flèche bas
                flecheBas = true;
            }
        }


        function relacherTouche(event) {
            //Enregistrer si une touche gauche/droite est relâchée
            if (event.keyCode == 39 || event.keyCode == 68) { //flèche droite
                /*if(coeur.posX < coeur.posXMax){
                    coeur.posX += coeur.vitesse;
                
                }*/
                flecheDroite = false;
            }

            if (event.keyCode == 37 || event.keyCode == 65) { //flèche gauche
                /*if(coeur.posX > coeur.posXMin){
                    coeur.posX -= coeur.vitesse;
                
                }*/
                flecheGauche = false;
            }

            //Enregistrer si une touche haut/bas est relâchée
            if (event.keyCode == 38 || event.keyCode == 87) { //flèche haut
                /*if(coeur.posY > coeur.posYMin){
                    coeur.posY -= coeur.vitesse;               
            }*/
                flecheHaut = false;
            }
            if (event.keyCode == 40 || event.keyCode == 83) { //flèche bas
                /*if(coeur.posY < coeur.posYMax){
                    coeur.posY += coeur.vitesse;
                }*/
                flecheBas = false;
            }
            if (event.keyCode == 88){
                if(skip==false){
                    skip=true;
                }else{
                    skip=false;
                }
            }


            //On part le jeu si le joueur appuie sur la touche 1, 2 ou 3
            //On part le setInterval qui actualise l'animation
            //On mémorise que le jeu est débuté
            //console.log(event.keyCode)
            if (event.keyCode == 49 && debutJeu == false) {
                debutJeu = true;
                difficultéChoisie = difficulté1;
                //Actualiser l'animation du début
                intervalIDAnimationDebut = setInterval(animationDebut, 1000/24);
            } else if (event.keyCode == 50 && debutJeu == false) {
                            debutJeu = true;
                difficultéChoisie = difficulté2;
                //Actualiser l'animation du début
                intervalIDAnimationDebut = setInterval(animationDebut, 1000/24);
            } else if (event.keyCode == 51 && debutJeu == false) {
                            debutJeu = true;
                difficultéChoisie = difficulté3;
                //Actualiser l'animation du début
                intervalIDAnimationDebut = setInterval(animationDebut, 1000/24);
            }
        }
        //Détecte si l'objet 1 touche l'objet 2
        function detecterCollision(imgObjet2, posXObjet2, posYObjet2) {

            if (coeur.posX < posXObjet2 + imgObjet2.width &&
                coeur.posX + coeur.largeur > posXObjet2 &&
                coeur.posY < posYObjet2 + imgObjet2.height &&
                coeur.posY + coeur.hauteur > posYObjet2 &&
                (enTir||enTirH) == true) {
 
                return true;
            } else {
                return false;
            }
        }
        //créer l'animation du début
        function animationDebut(){
            //Effacer le contenu actuel du contexte de rendu du canvas
            ctx.clearRect(0, 0, leCanvas.width, leCanvas.height);
            // Dessiner Sans
            ctx.drawImage(sans.img, sans.posX, 0);
            //Dessiner le coeur
            ctx.drawImage(coeur.img, coeur.posX, coeur.posY);
            //Dessiner la zone de jeu
            ctx.drawImage(zoneJeu.img, zoneJeu.posX, zoneJeu.posY);
            //déplacement de sans vers la gauche
            sans.posX -= sans.vitesseX;
            if(sans.posX < sans.posXMax){
                sans.posX = sans.posXMax;
                ctx.drawImage(bulle.img, bulle.posX, bulle.posY);
            }
            if(skip == true){
                console.log("salut");
                sans.posX += (sans.vitesseX*2);
            }
            if(sans.posX > sans.posXMin){
                sans.posX = sans.posXMin;
                animFin = true;
            }
            if(animFin == true){
                //Actualiser le jeu
                intervalIDActualiserJeu = setInterval(actualiserJeu, 1000 / 18);
                //Actualiser Skull
                intervalIDAnimerSkull = setInterval(animerSkull, 1000 / difficultéChoisie);
                intervalIDAnimerSkullH = setInterval(animerSkullH, 1000/difficultéChoisie);

                //Arrêter l'écoute pour la première musique
                leCanvas.removeEventListener("click", musique);
                musique2();
                leCanvas.addEventListener("click", musique2);
                clearInterval(intervalIDAnimationDebut);
                intervalIDScore = setInterval(score, 1000/1);
                intervalIDMinuterie = setInterval(minuterie, 1000/ 24);
                setInterval(sansBattu, 1000/1);
                intervalIDAfficherNombreVie = setInterval(afficherNombreVie, 1000 / 60);
                intervalIDAfficherViesSans = setInterval(afficherViesSans, 1000 / 60);
                intervalIDTimer = setInterval(minuterieFin, 1000/1);
                skip=false;
            }
        }
        //Actualiser l'affichage des objets et les actions du jeu
        function actualiserJeu() {
            //Effacer le contenu actuel du contexte de rendu du canvas
            ctx.clearRect(0, 0, leCanvas.width, leCanvas.height);

            //Faire apparaître le skull - Géré autrement - uniquement le dessiner
            //animerSkull();
            ctx.drawImage(skull.img, skull.sourceX, 0, skull.largeur, skull.hauteur, skull.posX, skull.posY, skull.largeur, skull.hauteur);

            //animerSkullH();
            ctx.drawImage(skullH.img, skullH.sourceX, 0, skullH.largeur, skullH.hauteur, skullH.posX, skullH.posY, skullH.largeur, skullH.hauteur);
            //Déplacer le personnage
            deplacerPersonnage();

            //Dessiner Sans
            ctx.drawImage(sans.img, sans.posX, 0)

            //Dessiner la zone de jeu
            ctx.drawImage(zoneJeu.img, zoneJeu.posX, zoneJeu.posY);
            //Dessiner la minuterie
            minuterie();
            

            //********Détecter Colisions**************//

            //Vérifie si le coeur et le skull se touchent
            let siContactCoeurEtSkull = detecterCollision(attaque.img, skull.posX, attaque.posY);
            let siContactCoeurEtSkullH = detecterCollision(attaqueH.img, attaqueH.posX, skullH.posY);

            //si contacte alors le personnge perd le scor de la vie et change l'image du personnage 
            if (siContactCoeurEtSkull == true || siContactCoeurEtSkullH == true) {
                finJeu();
            }
        }
        function finJeu(){
                //Changer l'image pour le coeur brisé
                //ctx.drawImage(coeur.img2, coeur.posX, coeur.posY);

                //Diminuer les pv
                nombreVies -= 1;
                //recommencer();
            
            //si le joueur est à court de PV on arrête le jeu
            if (nombreVies <= 0){
                clearInterval(intervalIDAnimationDebut);
                clearInterval(intervalIDActualiserJeu);
                clearInterval(intervalIDAnimerSkull);
                clearInterval(intervalIDAnimerSkullH);
                clearInterval(intervalIDTirer);
                clearInterval(intervalIDTirerH);
                clearInterval(intervalIDMinuterie);
                clearInterval(intervalIDScore);
                clearInterval(intervalIDAfficherNombreVie);
                clearInterval(intervalIDAfficherViesSans);
                clearTimeout(tir);
                clearTimeout(tirH);
                megalovania.pause();
                musique3();
                console.log("minuterie arrêté")
                let intervalIDFin = setInterval(ecranFin, 1000/100);
            }
        }
        function sansBattu(){
            /*if(temps == 5){
                nombreViesSans -= 3;
            }*/
            if(temps == 20){
                nombreViesSans -= 1;
            }else if(temps == 50){
                nombreViesSans -=1;
            }else if(temps == 70){
                nombreViesSans -= 1;
            }
            if(nombreViesSans == 0){
                clearInterval(intervalIDAnimationDebut);
                clearInterval(intervalIDActualiserJeu);
                clearInterval(intervalIDAnimerSkull);
                clearInterval(intervalIDAnimerSkullH);
                clearInterval(intervalIDTirer);
                clearInterval(intervalIDTirerH);
                clearInterval(intervalIDMinuterie);
                clearInterval(intervalIDAfficherNombreVie);
                clearInterval(intervalIDAfficherViesSans);
                clearInterval(intervalIDScore);
                clearTimeout(tir);
                clearTimeout(tirH);
                megalovania.pause();
                musique4();
                console.log("minuterie arrêté")
                let intervalIDFin2 = setInterval(sansBattuFin, 1000/100);
            }
        }
        function minuterieFin(){
            timer += 1;
            console.log("timer");
        }
        function sansBattuFin(){
            
            ctx.clearRect(0,0,leCanvas.width,leCanvas.height);
            
            //Dessiner Sans
            ctx.drawImage(sans.img2, sans.posX,0);
            
            //Dessiner la zone de jeu
            ctx.drawImage(zoneJeu.img, zoneJeu.posX, zoneJeu.posY);
            //Animation de fin
            sans.posX-= sans.vitesseX;
            if(sans.posX < sans.posXMax){
                sans.posX = sans.posXMax;
                bulle.img.src="images/bulle3.png";
                ctx.drawImage(bulle.img, bulle.posX, bulle.posY);
            }
        }
        
            //fin du jeu
        function ecranFin(){
            ctx.clearRect(0,0,leCanvas.width,leCanvas.height);
            
            ctx.drawImage(coeur.img2, leCanvas.width/2 - coeur.largeur, leCanvas.height/2 - coeur.hauteur);
            minuterie();
        }
            

        
        function recommencer(){
            document.location.reload();
            
        }

        //Fonction pour déplacer le personnage
        function deplacerPersonnage() {


            //Calculer les futures positions de l'objet1
            if (flecheDroite) {
                if (coeur.posX < coeur.posXMax) {
                    coeur.posX += coeur.vitesse;
                }
            }
            if (flecheGauche) {
                if (coeur.posX > coeur.posXMin) {
                    coeur.posX -= coeur.vitesse;
                }
            }

            if (flecheHaut) {
                if (coeur.posY > coeur.posYMin) {
                    coeur.posY -= coeur.vitesse;
                }
            }
            if (flecheBas) {
                if (coeur.posY < coeur.posYMax) {
                    coeur.posY += coeur.vitesse;
                }
            }

            ctx.drawImage(coeur.img, coeur.posX, coeur.posY)
        }






        //Fonction npour animer la feuille de sprite du skull
        function animerSkull() {
            //Effacer le contenu actuel du contexte de rendu du canvas
            //ctx.clearRect(0, 0, leCanvas.width, leCanvas.height);

            //Gérer adéquatement l'affichage et l'animation de la feuille de sprites du skull


            //Incrémenter et gérer l'index de la vignette à afficher
            skull.indexVignette++;
            //console.log(skull.indexVignette);

            skull.sourceX = skull.indexVignette * skull.largeur;

            //Quand skull est rendu à la vignette 10...on tire pendant .5 secondes
            if (skull.indexVignette == skull.nbVignettes-1) {
                //Arreter l'animation de Skull
                console.log("Arreter l'animation de skull");
                clearInterval(intervalIDAnimerSkull);

                //Partir l'animation pour le tir
                intervalIDTirer = setInterval(tirer, 1000 / 60);

                //Les tirs durent 4 secondes
                tir = setTimeout(arreterLesTirs, 500);
                attaque.largeur = 0;
                attaque.hauteur = 0;
                attaque.posY = -1;
            } 
                
                
                
            

            //Si toute les Images ont été parcourues alors on remet l'index à 0 pour recommencer la séquence
            if (skull.indexVignette == skull.nbVignettes) {
                skull.posX = (leCanvas.width / 2 - 350) + (Math.ceil(Math.random() * 5) * 100);
                skull.indexVignette = 0;
            }
        }

        function tirer() {
            console.log("tirer");
            skullAttaque.play();
            //Ici on tire...
            enTir = true;
            //Dessiner l'image de l'attaque
                attaque.largeur = 100;
                attaque.hauteur = 300;
                attaque.posY = leCanvas.height/2;
                ctx.drawImage(attaque.img, skull.posX, attaque.posY);

        }

        function arreterLesTirs() {
            //Arrêter les tirs
            clearInterval(intervalIDTirer);
            enTir = false;
            
            //Repartir l'animation de Skull
            intervalIDAnimerSkull = setInterval(animerSkull, 1000 / difficultéChoisie);
            skullAttaque.pause();
            skullAttaque.currentTime = 0.5;
        }

        function animerSkullH() {
            //Effacer le contenu actuel du contexte de rendu du canvas
            //ctx.clearRect(0, 0, leCanvas.width, leCanvas.height);

            //Gérer adéquatement l'affichage et l'animation de la feuille de sprites du diamant
            //ctx.drawImage(skullH.img, skullH.sourceX, 0, skullH.largeur, skullH.hauteur, skullH.posX, skullH.posY, skullH.largeur, skullH.hauteur);
            
            //Incrémenter et gérer l'index de la vignette à afficher
            skullH.indexVignette ++;
            console.log(skullH.indexVignette);
            
            skullH.sourceX = skullH.indexVignette * skullH.largeur;
            //Quand skullH est rendu à la vignette 10...on tire pendant .5 secondes
            if (skullH.indexVignette == skullH.nbVignettes-1) {
                //Arreter l'animation de Skull
                console.log("Arreter l'animation de skullH");
                clearInterval(intervalIDAnimerSkullH);

                //Partir l'animation pour le tir
                intervalIDTirerH = setInterval(tirerH, 1000 / 60);

                //Les tirs durent 4 secondes
                tirH = setTimeout(arreterLesTirsH, 500);
                attaqueH.largeur = 0;
                attaqueH.hauteur = 0;
                attaqueH.posX = -1;
            }
 
            //Si toute les Images ont été parcourues alors on remet l'index à 0 pour recommencer la séquence
            if(skullH.indexVignette == skullH.nbVignettes){
                skullH.posY = (leCanvas.height/2 - 100) + (Math.ceil(Math.random()*3)*100);
                skullH.indexVignette = 0;
            }
        }
        function tirerH() {
            console.log("tirerH");
            //Ici on tire...
            enTirH = true;
            skullAttaque.play();
            //Dessiner l'image de l'attaque
                attaqueH.largeur = 500;
                attaqueH.hauteur = 100;
                attaqueH.posX = leCanvas.width/2-250;
                ctx.drawImage(attaqueH.img, attaqueH.posX, skullH.posY);

        }

        function arreterLesTirsH() {
            //Arrêter les tirs
            clearInterval(intervalIDTirerH);
            enTirH = false;
            
            //Repartir l'animation de SkullH
            intervalIDAnimerSkullH = setInterval(animerSkullH, 1000 / difficultéChoisie);
            skullAttaque.pause();
            skullAttaque.currentTime = 0.5;
        }
        function score(){
            temps += 1;
        }
        function minuterie() {
            console.log("timer démaré");
            //Ici on tire...
            ctx.font = "bold 36px Arial";
            ctx.fillStyle = "white";
            ctx.textBaseline = "left";
            ctx.textAlign = "left";
            ctx.fillText("temps de survie: " + temps + "sec", 0, 30);

        }
        function afficherNombreVie() {
            vie.posX = leCanvas.width-100;
            for (let index = 0; index < nombreVies; index++) {
                ctx.drawImage(vie.img, vie.posX, vie.posY);
                vie.posX = vie.posX - vie.largeur;
            }
        }
        function afficherViesSans() {
            sansVie.posX = 0;
            sansVie.posY = 60;
            for (let index = 0; index < nombreViesSans; index++) {
                ctx.drawImage(sansVie.img, sansVie.posX, sansVie.posY);
                sansVie.posX = sansVie.posX + sansVie.largeur;
            }
        }

    </script>
</body>

</html>
